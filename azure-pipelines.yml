# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- master
- codecov

pool:
  vmImage: ubuntu-latest
strategy:
  matrix:
    Python37:
      python.version: '3.7'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(python.version)'
  displayName: 'Use Python $(python.version)'

- script: |
    conda config --set always_yes yes
    conda install -c conda-forge lcov pytest
  displayName: 'Install lcov'

- script: |
    echo '[CMakeBuild]\ncode_coverage=ON\n' > setup.cfg
    python setup.py develop
  displayName: 'Compile wicked'

- script: |
    pip install pytest pytest-azurepipelines
    pytest tests
  displayName: 'Run pytest'

- script: |
    lcov --directory . --capture --output-file coverage.info
    lcov --remove coverage.info '/usr/*;*fmt*;*c++*;*pybind11*' --output-file coverage.info
    lcov --list coverage.info #debug info
    bash <(curl -s https://codecov.io/bash) 
  displayName: 'Upload to codecov.io'
